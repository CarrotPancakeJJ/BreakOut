local UserInputService = game:GetService("UserInputService")
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local RunService = game:GetService("RunService")

local player = Players.LocalPlayer
local inRound = ReplicatedStorage:WaitForChild("InRound")
local movePaddleEvent = ReplicatedStorage:WaitForChild("MovePaddle")

-------------------------------------------------
-- Killer / Round ì²´í¬
-------------------------------------------------
local function isKiller()
	return player.Team and player.Team.Name == "Killer"
end

local function canMovePaddle()
	return isKiller() and inRound.Value
end

-------------------------------------------------
-- ì´ë™ ìƒíƒœ ë³€ìˆ˜
-------------------------------------------------
local movingLeft = false
local movingRight = false

-- ë§ˆì§€ë§‰ìœ¼ë¡œ ì„œë²„ì— ë³´ë‚¸ ë°©í–¥ (ì¤‘ë³µ ì „ì†¡ ë°©ì§€ìš©)
local lastSentDirection = 0

-------------------------------------------------
-- ì„œë²„ ì „ì†¡ ìµœì í™” í•¨ìˆ˜
-------------------------------------------------
local function updateMovement()
	if not canMovePaddle() then
		return
	end

	local targetDirection = 0
	if movingLeft then
		targetDirection = -1
	elseif movingRight then
		targetDirection = 1
	end

	-- **ì¤‘ìš”: ë°©í–¥ì´ ë³€ê²½ë˜ì—ˆì„ ë•Œë§Œ ì„œë²„ì— ì „ì†¡**
	if targetDirection ~= lastSentDirection then
		lastSentDirection = targetDirection
		movePaddleEvent:FireServer(targetDirection)
		-- print("ë°©í–¥ ì „ì†¡:", targetDirection) -- ë””ë²„ê¹…ìš©
	end
end

-------------------------------------------------
-- PC í‚¤ë³´ë“œ ìž…ë ¥
-------------------------------------------------
local function setKeyState(keyCode, isDown)
	if keyCode == Enum.KeyCode.A or keyCode == Enum.KeyCode.Left then
		movingLeft = isDown
	elseif keyCode == Enum.KeyCode.D or keyCode == Enum.KeyCode.Right then
		movingRight = isDown
	end
	updateMovement() -- í‚¤ ìž…ë ¥ ìƒíƒœê°€ ë³€í•  ë•Œ ì¦‰ì‹œ ì²´í¬
end

UserInputService.InputBegan:Connect(function(input, gp)
	if gp then
		return
	end
	setKeyState(input.KeyCode, true)
end)

UserInputService.InputEnded:Connect(function(input)
	setKeyState(input.KeyCode, false)
end)

-------------------------------------------------
-- ðŸ“± ëª¨ë°”ì¼ ìŠ¤ì™€ì´í”„
-------------------------------------------------
local touchStartX = nil
local SWIPE_THRESHOLD = 35

UserInputService.TouchStarted:Connect(function(touch, gp)
	if gp then
		return
	end
	touchStartX = touch.Position.X
end)

UserInputService.TouchMoved:Connect(function(touch, gp)
	if not touchStartX then
		return
	end

	-- Killerë‚˜ ë¼ìš´ë“œ ì²´í¬ëŠ” updateMovementì—ì„œ í•œ ë²ˆ ë” í•˜ë¯€ë¡œ ì—¬ê¸°ì„  ë‹¨ìˆœí™” ê°€ëŠ¥

	local deltaX = touch.Position.X - touchStartX

	if deltaX > SWIPE_THRESHOLD then
		movingRight = true
		movingLeft = false
	elseif deltaX < -SWIPE_THRESHOLD then
		movingLeft = true
		movingRight = false
	else
		movingLeft = false
		movingRight = false
	end

	updateMovement() -- í„°ì¹˜ ì´ë™ ì¤‘ ìƒíƒœ ë³€í™” ì²´í¬
end)

UserInputService.TouchEnded:Connect(function()
	touchStartX = nil
	movingLeft = false
	movingRight = false
	updateMovement() -- ì†ì„ ë—ì„ ë•Œ ë©ˆì¶¤ ì „ì†¡
end)

-- RenderStepped ë£¨í”„ ì œê±°ë¨: ì´ì œ ì´ë²¤íŠ¸ ê¸°ë°˜ìœ¼ë¡œ ìž‘ë™í•˜ì—¬ ë„¤íŠ¸ì›Œí¬ ë¶€í•˜ê°€ íšê¸°ì ìœ¼ë¡œ ì¤„ì–´ë“­ë‹ˆë‹¤.
print("âœ… ìµœì í™”ëœ ìž…ë ¥ ì‹œìŠ¤í…œ ë¡œë“œ ì™„ë£Œ")
