local Players = game:GetService("Players")
local Teams = game:GetService("Teams")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

-- ê²Œì„ ì¢…ë£Œ í”Œë˜ê·¸ ì¶”ê°€
local lobbyTeam = Teams:FindFirstChild("Lobby")
local InRound = ReplicatedStorage:WaitForChild("InRound")
local Status = ReplicatedStorage:WaitForChild("Status")
local Inform = ReplicatedStorage:WaitForChild("Inform")
local IsRestrictMovement = ReplicatedStorage:WaitForChild("IsRestrictMovement")
local event = ReplicatedStorage:WaitForChild("PlayDeathSound")

-- LobbySpawn ì°¾ê¸°
local function getRandomLobbySpawn()
	local lobbySpawns = {}

	-- workspaceì—ì„œ LobbySpawn ì°¾ê¸°
	for _, obj in pairs(workspace:GetChildren()) do
		if obj:IsA("BasePart") and obj.Name:match("^LobbySpawn") then
			table.insert(lobbySpawns, obj)
		end
	end

	-- LobbyObjects í´ë”ì—ì„œë„ ì°¾ê¸°
	local lobbyObjectsFolder = workspace:FindFirstChild("LobbyObjects")
	if lobbyObjectsFolder then
		local lobbySpawnsFolder = lobbyObjectsFolder:FindFirstChild("LobbySpawns")
		if lobbySpawnsFolder then
			for _, obj in pairs(lobbySpawnsFolder:GetChildren()) do
				if obj:IsA("BasePart") and obj.Name:match("^LobbySpawn") then
					table.insert(lobbySpawns, obj)
				end
			end
		end
	end

	if #lobbySpawns > 0 then
		return lobbySpawns[math.random(1, #lobbySpawns)]
	end

	return workspace:FindFirstChild("LobbySpawn")
end

-- ê° í”Œë ˆì´ì–´ì˜ í…”ë ˆí¬íŠ¸ ì²˜ë¦¬ ìƒíƒœ ì¶”ì 
local teleportingPlayers = {}

Players.PlayerAdded:Connect(function(player)
	player.CharacterAdded:Connect(function(character)
		local humanoid = character:WaitForChild("Humanoid")
		local humanoidRootPart = character:WaitForChild("HumanoidRootPart")

		-- ì£½ì—ˆì„ ë•Œ
		humanoid.Died:Connect(function()
			--event:FireAllClients()

			if InRound.Value and player.Team and player.Team.Name == "Player" then
				-- íƒˆë½ ë©”ì‹œì§€ í‘œì‹œ
				Inform.Value = "ğŸ’€ " .. player.Name .. " Eliminated!"
			end
			-- Lobby íŒ€ìœ¼ë¡œ ë³€ê²½
			if lobbyTeam then
				player.Team = lobbyTeam
				player.TeamColor = lobbyTeam.TeamColor
				teleportingPlayers[player.UserId] = true
				print(player.Name .. " ì‚¬ë§ - Lobby íŒ€ìœ¼ë¡œ ì´ë™")

				-- ê²Œì„ ì¤‘ì´ë¼ë©´ ìŠ¹íŒ¨ ì²´í¬ (ì¶”ê°€!)
				if InRound.Value then
					-- ì ê¹ ëŒ€ê¸° í›„ ì²´í¬ (ë‹¤ë¥¸ í”Œë ˆì´ì–´ ìƒíƒœë„ í™•ì¸í•˜ê¸° ìœ„í•´)
					task.wait(0.5)
				end
			end
		end)

		-- ë¦¬ìŠ¤í° ì§í›„ ì²˜ë¦¬ (ì¤‘ìš”: ì•½ê°„ì˜ ë”œë ˆì´ í•„ìš”)
		task.wait(0.5)

		-- Lobby íŒ€ì´ê³  í…”ë ˆí¬íŠ¸ê°€ í•„ìš”í•œ ê²½ìš°
		if player.Team == lobbyTeam and teleportingPlayers[player.UserId] then
			-- Anchored í•´ì œ (í˜¹ì‹œ Killerì˜€ë‹¤ë©´)
			humanoidRootPart.Anchored = false

			-- ë¡œë¹„ë¡œ í…”ë ˆí¬íŠ¸
			local lobbySpawn = getRandomLobbySpawn()
			if lobbySpawn then
				humanoidRootPart.CFrame = lobbySpawn.CFrame + Vector3.new(0, 3, 0) -- ì•½ê°„ ìœ„ì—ì„œ ìŠ¤í°
				print(player.Name .. " (Lobby íŒ€) ë¡œë¹„ë¡œ í…”ë ˆí¬íŠ¸")
			end

			teleportingPlayers[player.UserId] = false
		end
	end)
end)

-- í”Œë ˆì´ì–´ ë‚˜ê°ˆ ë•Œ ì •ë¦¬
Players.PlayerRemoving:Connect(function(player)
	teleportingPlayers[player.UserId] = nil
end)
