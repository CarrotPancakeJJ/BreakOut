local intermission = 25
local roundLength = 110
local ReplicatedStorage = game:GetService("ReplicatedStorage")

local InRound = ReplicatedStorage.InRound
local status = ReplicatedStorage.Status
local IsSolo = ReplicatedStorage.IsSolo
local IsRestrictMovement = ReplicatedStorage.IsRestrictMovement
local Winner = ReplicatedStorage:WaitForChild("Winner")
local showModeEvent = ReplicatedStorage:WaitForChild("ShowMode")
local Mode = ReplicatedStorage:WaitForChild("Mode")

local modeList = {
	"Classic",
	"LowGravity",
	"Speed",
	"Double",
}

local soundService = game:GetService("SoundService")
local Players = game:GetService("Players")

local gameObjects = workspace:FindFirstChild("GameObjects")
local cameraPart = gameObjects and gameObjects:FindFirstChild("CameraPart")

local Teams = game:GetService("Teams")
local killerTeam = Teams:FindFirstChild("Killer")
local playerTeam = Teams:FindFirstChild("Player")
local gameEnded = false

-- í˜„ì¬ ì¬ìƒ ì¤‘ì¸ ìŒì•… ì¶”ì 
local currentMusic = nil
local musicConnection = nil

-- GameManagerì˜ í•¨ìˆ˜ë“¤ì´ ë¡œë“œë  ë•Œê¹Œì§€ ëŒ€ê¸°
task.wait(0.1)

-- ê²Œì„ ì‹œì‘ ì‹œ startGameWall ì›ë³¸ì €ì¥
local originalStartGameWall = nil
local gameObjectsFolder = workspace:FindFirstChild("GameObjects")
if gameObjectsFolder then
	originalStartGameWall = gameObjectsFolder:FindFirstChild("StartGameWall")
	if originalStartGameWall then
		originalStartGameWall = originalStartGameWall:Clone()
	end
end

-- StartGameWall ìƒì„± í•¨ìˆ˜
local function createStartGameWall()
	if not originalStartGameWall then
		warn("ì›ë³¸ StartGameWallì´ ì—†ìŠµë‹ˆë‹¤!")
		return
	end

	local gameObjectsFolder = workspace:FindFirstChild("GameObjects")
	if gameObjectsFolder then
		local existingWall = gameObjectsFolder:FindFirstChild("StartGameWall")
		if existingWall then
			existingWall:Destroy()
		end

		local newWall = originalStartGameWall:Clone()
		newWall.Parent = gameObjectsFolder
		print("StartGameWallì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.")
	end
end

-- MapSpawn ëª©ë¡ ê°€ì ¸ì˜¤ê¸° í•¨ìˆ˜
local function getMapSpawns()
	local mapSpawns = {}

	for _, obj in pairs(workspace:GetChildren()) do
		if obj:IsA("BasePart") and obj.Name:match("^MapSpawn") then
			table.insert(mapSpawns, obj)
		end
	end

	local gameObjectsFolder = workspace:FindFirstChild("GameObjects")
	local mapSpawnsFolder = gameObjectsFolder and gameObjectsFolder:FindFirstChild("MapSpawns")
	if mapSpawnsFolder then
		for _, obj in pairs(mapSpawnsFolder:GetChildren()) do
			if obj:IsA("BasePart") and obj.Name:match("^MapSpawn") then
				table.insert(mapSpawns, obj)
			end
		end
	end

	return mapSpawns
end

-- ëœë¤ MapSpawn ì„ íƒ í•¨ìˆ˜
local function getRandomMapSpawn()
	local mapSpawns = getMapSpawns()

	if #mapSpawns == 0 then
		warn("MapSpawnì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê¸°ë³¸ MapSpawnì„ ì‚¬ìš©í•©ë‹ˆë‹¤.")
		local defaultSpawn = workspace:FindFirstChild("MapSpawn")
		if defaultSpawn and defaultSpawn:IsA("BasePart") then
			return defaultSpawn
		end
		return nil
	end

	local randomIndex = math.random(1, #mapSpawns)
	return mapSpawns[randomIndex]
end

-- LobbySpawn ëª©ë¡ ê°€ì ¸ì˜¤ê¸° í•¨ìˆ˜
local function getLobbySpawns()
	local lobbySpawns = {}

	for _, obj in pairs(workspace:GetChildren()) do
		if obj:IsA("BasePart") and obj.Name:match("^LobbySpawn") then
			table.insert(lobbySpawns, obj)
		end
	end

	local lobbyObjectsFolder = workspace:FindFirstChild("LobbyObjects")
	local lobbySpawnsFolder = lobbyObjectsFolder and lobbyObjectsFolder:FindFirstChild("LobbySpawns")
	if lobbySpawnsFolder then
		for _, obj in pairs(lobbySpawnsFolder:GetChildren()) do
			if obj:IsA("BasePart") and obj.Name:match("^LobbySpawn") then
				table.insert(lobbySpawns, obj)
			end
		end
	end

	return lobbySpawns
end

-- ëœë¤ LobbySpawn ì„ íƒ í•¨ìˆ˜
local function getRandomLobbySpawn()
	local lobbySpawns = getLobbySpawns()

	if #lobbySpawns == 0 then
		warn("LobbySpawnì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê¸°ë³¸ LobbySpawnì„ ì‚¬ìš©í•©ë‹ˆë‹¤.")
		local defaultSpawn = workspace:FindFirstChild("LobbySpawn")
		if defaultSpawn and defaultSpawn:IsA("BasePart") then
			return defaultSpawn
		end
		return nil
	end

	local randomIndex = math.random(1, #lobbySpawns)
	return lobbySpawns[randomIndex]
end

-- StartGameWall ì œê±° í•¨ìˆ˜
local function removeStartGameWall()
	local gameObjectsFolder = workspace:FindFirstChild("GameObjects")
	local startGameWall = gameObjectsFolder and gameObjectsFolder:WaitForChild("StartGameWall")
	if startGameWall then
		startGameWall:Destroy()
		print("StartGameWallì´ ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤.")
	else
		local startGameWallFolder = workspace:FindFirstChild("StartGameWall")
		if startGameWallFolder then
			startGameWallFolder:Destroy()
			print("StartGameWall í´ë”/ëª¨ë¸ì´ ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤.")
		end
	end
end

-- í˜„ì¬ ìŒì•… ì •ì§€ í•¨ìˆ˜
local function stopCurrentMusic()
	if musicConnection then
		musicConnection:Disconnect()
		musicConnection = nil
	end

	if currentMusic then
		currentMusic:Stop()
		currentMusic = nil
	end
end

-- ë¡œë¹„ ìŒì•… ì¬ìƒ í•¨ìˆ˜
local function playLobbyMusic()
	stopCurrentMusic()

	local lobbyMusicFolder = soundService:FindFirstChild("LobbyMusic")
	if not lobbyMusicFolder then
		warn("SoundServiceì—ì„œ LobbyMusic í´ë”ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
		return
	end

	local musicTracks = {}
	for _, sound in pairs(lobbyMusicFolder:GetChildren()) do
		if sound:IsA("Sound") then
			table.insert(musicTracks, sound)
		end
	end

	if #musicTracks == 0 then
		warn("LobbyMusic í´ë”ì— ìŒì•…ì´ ì—†ìŠµë‹ˆë‹¤.")
		return
	end

	local randomIndex = math.random(1, #musicTracks)
	currentMusic = musicTracks[randomIndex]
	currentMusic:Play()

	musicConnection = currentMusic.Ended:Connect(function()
		playLobbyMusic()
	end)
	print("ë¡œë¹„ ìŒì•… ì¬ìƒ: " .. currentMusic.Name)
end

-- ê²Œì„ ìŒì•… ì¬ìƒ í•¨ìˆ˜
local function playGameMusic()
	stopCurrentMusic()

	local gameMusicFolder = soundService:FindFirstChild("GameMusic")
	if not gameMusicFolder then
		warn("SoundServiceì—ì„œ GameMusic í´ë”ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
		return
	end

	local musicTracks = {}
	for _, sound in pairs(gameMusicFolder:GetChildren()) do
		if sound:IsA("Sound") then
			table.insert(musicTracks, sound)
		end
	end

	if #musicTracks == 0 then
		warn("GameMusic í´ë”ì— ìŒì•…ì´ ì—†ìŠµë‹ˆë‹¤.")
		return
	end

	local randomIndex = math.random(1, #musicTracks)
	currentMusic = musicTracks[randomIndex]
	currentMusic:Play()

	musicConnection = currentMusic.Ended:Connect(function()
		playGameMusic()
	end)
	print("ê²Œì„ ìŒì•… ì¬ìƒ: " .. currentMusic.Name)
end

-- í”Œë ˆì´ì–´ë¥¼ íˆ¬ëª…í•˜ê²Œ ë§Œë“œëŠ” í•¨ìˆ˜
local function makePlayerInvisible(character)
	for _, part in pairs(character:GetDescendants()) do
		if part:IsA("BasePart") then
			part.Transparency = 1
		else
			pcall(function()
				if part.Transparency then
					part.Transparency = 1
				end
			end)
		end
	end
	print(character.Name .. " íˆ¬ëª…í™” ì™„ë£Œ")
end

-- í”Œë ˆì´ì–´ë¥¼ ë³´ì´ê²Œ ë§Œë“œëŠ” í•¨ìˆ˜
local function makePlayerVisible(character)
	for _, part in pairs(character:GetDescendants()) do
		if part:IsA("BasePart") then
			if part.Name == "HumanoidRootPart" then
				part.Transparency = 1
			else
				part.Transparency = 0
			end
		else
			pcall(function()
				if part.Transparency then
					part.Transparency = 0
				end
			end)
		end
	end
	print(character.Name .. " ê°€ì‹œí™” ì™„ë£Œ")
end

-- ì‚´ì•„ìˆëŠ” Player íŒ€ì› ìˆ˜ í™•ì¸
local function getAlivePlayers()
	local playerTeam = Teams:FindFirstChild("Player")
	local alivePlayers = {}

	for _, player in pairs(Players:GetPlayers()) do
		if player.Team == playerTeam then
			local character = player.Character
			if character then
				local humanoid = character:FindFirstChild("Humanoid")
				if humanoid and humanoid.Health > 0 then
					table.insert(alivePlayers, player)
				end
			end
		end
	end

	return alivePlayers
end

local function ReturnLobby()
	if _G.resetKillerSelection then
		_G.resetKillerSelection()
	end
	if _G.skyRandomSelect then
		_G.skyRandomSelect()
	end
	local lobbyTeam = Teams:FindFirstChild("Lobby")
	for _, plr in pairs(Players:GetPlayers()) do
		local randomLobbySpawn = getRandomLobbySpawn()
		local char = plr.Character

		if char then
			local humanoid = char:FindFirstChild("Humanoid")
			if humanoid then
				humanoid.WalkSpeed = 16
			end
			local humanRoot = char:FindFirstChild("HumanoidRootPart")
			if humanRoot then
				humanRoot.CFrame = randomLobbySpawn.CFrame
				humanRoot.Anchored = false
			end

			makePlayerVisible(char)
		end

		if lobbyTeam then
			plr.Team = lobbyTeam
			plr.TeamColor = lobbyTeam.TeamColor
		end
	end

	Winner.Value = "None"
	playLobbyMusic()
end

-- íŒ€ ìŠ¹ë¦¬ ì²˜ë¦¬
local function handleVictory(winningTeam)
	gameEnded = true
	InRound.Value = false
	IsRestrictMovement.Value = false

	local teamName = winningTeam.Name

	if teamName == "Killer" then
		Winner.Value = "Killer"
	else
		Winner.Value = "Player"
	end

	if teamName == "Killer" then
		status.Value = "ğŸ”ª KILLER WINS! ğŸ”ª"

		for _, player in pairs(Players:GetPlayers()) do
			if player.Team == winningTeam then
				local leaderstats = player:FindFirstChild("leaderstats")
				if leaderstats then
					local killerWins = leaderstats:FindFirstChild("Killer Wins")
					if killerWins then
						killerWins.Value = killerWins.Value + 1
					end
				end
			end
		end
	else
		status.Value = "ğŸ‰ PLAYERS WIN! ğŸ‰"

		for _, player in pairs(Players:GetPlayers()) do
			if player.Team == winningTeam then
				local leaderstats = player:FindFirstChild("leaderstats")
				if leaderstats then
					local playerWins = leaderstats:FindFirstChild("Player Wins")
					if playerWins then
						playerWins.Value = playerWins.Value + 1
					end
				end
			end
		end
	end

	print(teamName .. " íŒ€ ìŠ¹ë¦¬!")

	task.wait(5)
	ReturnLobby()
end

InRound.Changed:Connect(function()
	if InRound.Value == false then
		if _G.cleanupGame then
			_G.cleanupGame()
		end
	end

	if InRound.Value == false and not gameEnded then
		local Teams = game:GetService("Teams")
		local lobbyTeam = Teams:FindFirstChild("Lobby")

		IsRestrictMovement.Value = false

		for i, plr in pairs(game.Players:GetChildren()) do
			local randomLobbySpawn = getRandomLobbySpawn()
			local char = plr.Character
			if char then
				local humanRoot = char:WaitForChild("HumanoidRootPart")
				humanRoot.CFrame = randomLobbySpawn.CFrame
				humanRoot.Anchored = false
				makePlayerVisible(char)
			end

			if lobbyTeam then
				plr.Team = lobbyTeam
				plr.TeamColor = lobbyTeam.TeamColor
			end
		end

		playLobbyMusic()
	end
end)

local function CheckSpeedMode()
	if Mode.Value == "Speed" then
		for _, player in pairs(Players:GetPlayers()) do
			if player.Team == playerTeam then
				local character = player.Character
				if character then
					local humanoid = character:FindFirstChild("Humanoid")
					if humanoid and humanoid.Health > 0 then
						humanoid.WalkSpeed = 45
					end
				end
			end
		end
		roundLength = 55
	else
		roundLength = 110
	end
end

-- íŒ€ì— ë§ê²Œ í…”ë ˆí¬íŠ¸
local function teleportPlayersByTeam()
	if not cameraPart then
		warn("CameraPartë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!")
	end

	for _, plr in pairs(game.Players:GetPlayers()) do
		local char = plr.Character
		if char then
			local humanRoot = char:FindFirstChild("HumanoidRootPart")
			if humanRoot then
				if plr.Team == killerTeam and cameraPart then
					humanRoot.CFrame = cameraPart.CFrame
					humanRoot.Anchored = true
					makePlayerInvisible(char)
					print(plr.Name .. " (Killer) - CameraPartë¡œ í…”ë ˆí¬íŠ¸")
				elseif plr.Team == playerTeam then
					local randomMapSpawn = getRandomMapSpawn()
					if randomMapSpawn then
						humanRoot.CFrame = randomMapSpawn.CFrame
						humanRoot.Anchored = false
						makePlayerVisible(char)
						print(plr.Name .. " (Player) - " .. randomMapSpawn.Name .. "ìœ¼ë¡œ í…”ë ˆí¬íŠ¸")
					else
						warn(plr.Name .. "ì—ê²Œ ì¤„ MapSpawnì´ ì—†ìŠµë‹ˆë‹¤!")
					end
				end
			end
		end
	end
end

local function isKillerAlive()
	local killerTeam = Teams:FindFirstChild("Killer")
	if not killerTeam then
		return false
	end

	for _, player in pairs(Players:GetPlayers()) do
		if player.Team == killerTeam then
			local character = player.Character
			if character then
				local humanoid = character:FindFirstChild("Humanoid")
				if humanoid and humanoid.Health > 0 then
					return true
				end
			end
		end
	end

	return false
end

-- ëª¨ë“œ ì„ íƒ í•¨ìˆ˜
local function selectRandomMode()
	local selectedMode = modeList[math.random(1, #modeList)]
	Mode.Value = selectedMode
	-- ëª¨ë“  í´ë¼ì´ì–¸íŠ¸ì—ê²Œ ì„ íƒëœ ëª¨ë“œ ì „ì†¡
	showModeEvent:FireAllClients(selectedMode)

	print("ì„ íƒëœ ëª¨ë“œ:", selectedMode)
	return selectedMode
end

local function round()
	while true do
		InRound.Value = false
		IsSolo.Value = false
		IsRestrictMovement.Value = false
		gameEnded = false

		local killerTeam = Teams:FindFirstChild("Killer")
		local playerTeam = Teams:FindFirstChild("Player")

		for i = intermission, 0, -1 do
			status.Value = "Game will start in " .. i .. "s"
			task.wait(1)
		end

		local playerCount = #Players:GetPlayers()

		if playerCount > 1 then
			IsSolo.Value = false
		elseif playerCount == 1 then
			IsSolo.Value = true
		end

		InRound.Value = true
		-- NOT SOLO MODE
		if not IsSolo.Value then
			status.Value = "Selecting Mode..."
			selectRandomMode()
			task.wait(4)
			status.Value = "Selecting Killer..."
			_G.pickRandomPlayer()
			task.wait(4)
		-- SOLO MODE
		else
			status.Value = "Selecting Mode..."
			selectRandomMode()
			task.wait(3.5)
			status.Value = "Solo Mode! You are Player!"
			local getPlayer = Players:GetPlayers()
			local onePlayer = getPlayer[1]
			task.wait(3)
			onePlayer.Team = playerTeam
		end

		-- SPEED MODE
		CheckSpeedMode()

		-- SAME IN SOLO AND NOT SOLO MODE
		status.Value = "Teleporting to map..."
		teleportPlayersByTeam()

		IsRestrictMovement.Value = true

		playGameMusic()
		createStartGameWall()
		if _G.createBricks then
			_G.createBricks()
		end

		for i = 10, 0, -1 do
			status.Value = "Game starting in " .. i .. " seconds"
			task.wait(1)
		end

		removeStartGameWall()

		if _G.createBall then
			if Mode.Value == "Double" then
				_G.createBall(Vector3.new(0, 5, 0))
				_G.createBall(Vector3.new(3, 5, 0))
			else
				_G.createBall(Vector3.new(0, 5, 0))
			end
		end

		for i = roundLength, 0, -1 do
			if gameEnded then
				break
			end

			if not isKillerAlive() and not IsSolo.Value then
				status.Value = "Killer has left the game!"
				task.wait(2)

				local playerTeam = Teams:FindFirstChild("Player")
				handleVictory(playerTeam)
				break
			end

			local alivePlayers = getAlivePlayers()

			if #alivePlayers == 0 then
				status.Value = "All players eliminated!"
				task.wait(2)
				if not IsSolo.Value then
					handleVictory(killerTeam)
				end
				if IsSolo.Value then
					gameEnded = true
					InRound.Value = false
					task.wait(3)
					ReturnLobby()
				end
				break
			end

			if not IsSolo.Value then
				status.Value = "Time remaining: " .. i .. "s | Survivors: " .. #alivePlayers
			else
				status.Value = "Time remaining: " .. i .. "s"
			end
			task.wait(1)
		end

		if not gameEnded then
			local alivePlayers = getAlivePlayers()
			if #alivePlayers > 0 then
				status.Value = "Time's up! Players survived!"
				task.wait(2)
				if not IsSolo.Value then
					handleVictory(playerTeam)
				end
				if IsSolo.Value then
					gameEnded = true
					InRound.Value = false
					task.wait(3)
					ReturnLobby()
				end
			end
		end

		task.wait(3)
	end
end

-- ê²Œì„ ì‹œì‘ ì‹œ ë¡œë¹„ ìŒì•… ì¬ìƒ
playLobbyMusic()

-- ë¶€í™œ ê´€ë ¨ í•¨ìˆ˜ë¥¼ _Gì— export (Marketplace ìŠ¤í¬ë¦½íŠ¸ì—ì„œ ì‚¬ìš©)
_G.getRandomMapSpawn = getRandomMapSpawn
_G.makePlayerVisible = makePlayerVisible

task.spawn(round)
