local intermission = 30
local roundLength = 100

local InRound = game.ReplicatedStorage.InRound
local status = game.ReplicatedStorage.Status
local IsRestrictMovement = game.ReplicatedStorage.IsRestrictMovement -- ì¶”ê°€
local soundService = game:GetService("SoundService")
local Players = game:GetService("Players")

local gameObjects = workspace:FindFirstChild("GameObjects")
local cameraPart = gameObjects and gameObjects:FindFirstChild("CameraPart")

local Teams = game:GetService("Teams")
local gameEnded = false

-- í˜„ì¬ ì¬ìƒ ì¤‘ì¸ ìŒì•… ì¶”ì 
local currentMusic = nil
local musicConnection = nil

-- GameManagerì˜ í•¨ìˆ˜ë“¤ì´ ë¡œë“œë  ë•Œê¹Œì§€ ëŒ€ê¸°
task.wait(0.1)

-- ê²Œì„ ì‹œì‘ ì‹œ startGameWall ì›ë³¸ì €ì¥
local originalStartGameWall = nil
local gameObjectsFolder = workspace:FindFirstChild("GameObjects")
if gameObjectsFolder then
	originalStartGameWall = gameObjectsFolder:FindFirstChild("StartGameWall")
	if originalStartGameWall then
		originalStartGameWall = originalStartGameWall:Clone() -- ë³µì‚¬ë³¸ ì €ì¥
	end
end

-- StartGameWall ìƒì„± í•¨ìˆ˜
local function createStartGameWall()
	if not originalStartGameWall then
		warn("ì›ë³¸ StartGameWallì´ ì—†ìŠµë‹ˆë‹¤!")
		return
	end

	local gameObjectsFolder = workspace:FindFirstChild("GameObjects")
	if gameObjectsFolder then
		-- ê¸°ì¡´ ë²½ ì œê±°
		local existingWall = gameObjectsFolder:FindFirstChild("StartGameWall")
		if existingWall then
			existingWall:Destroy()
		end

		-- ìƒˆ ë²½ ìƒì„±
		local newWall = originalStartGameWall:Clone()
		newWall.Parent = gameObjectsFolder
		print("StartGameWallì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.")
	end
end

-- MapSpawn ëª©ë¡ ê°€ì ¸ì˜¤ê¸° í•¨ìˆ˜
local function getMapSpawns()
	local mapSpawns = {}

	-- ë°©ë²• 1: "MapSpawn"ìœ¼ë¡œ ì‹œì‘í•˜ëŠ” ëª¨ë“  íŒŒíŠ¸ ì°¾ê¸°
	for _, obj in pairs(workspace:GetChildren()) do
		if obj:IsA("BasePart") and obj.Name:match("^MapSpawn") then
			table.insert(mapSpawns, obj)
		end
	end

	-- ë°©ë²• 2: GameObjects í´ë” ì•ˆì—ì„œ "MapSpawn"ìœ¼ë¡œ ì‹œì‘í•˜ëŠ” íŒŒíŠ¸ë§Œ ì°¾ê¸°
	local gameObjectsFolder = workspace:FindFirstChild("GameObjects")
	local mapSpawnsFolder = gameObjectsFolder:FindFirstChild("MapSpawns")
	if mapSpawnsFolder then
		for _, obj in pairs(mapSpawnsFolder:GetChildren()) do
			if obj:IsA("BasePart") and obj.Name:match("^MapSpawn") then
				table.insert(mapSpawns, obj)
			end
		end
	end

	return mapSpawns
end

-- ëœë¤ MapSpawn ì„ íƒ í•¨ìˆ˜
local function getRandomMapSpawn()
	local mapSpawns = getMapSpawns()

	if #mapSpawns == 0 then
		warn("MapSpawnì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê¸°ë³¸ MapSpawnì„ ì‚¬ìš©í•©ë‹ˆë‹¤.")
		local defaultSpawn = workspace:FindFirstChild("MapSpawn")
		if defaultSpawn and defaultSpawn:IsA("BasePart") then
			return defaultSpawn
		end
		return nil
	end

	-- ëœë¤í•˜ê²Œ í•˜ë‚˜ ì„ íƒ
	local randomIndex = math.random(1, #mapSpawns)
	return mapSpawns[randomIndex]
end

-- LobbySpawn ëª©ë¡ ê°€ì ¸ì˜¤ê¸° í•¨ìˆ˜
local function getLobbySpawns()
	local lobbySpawns = {}

	-- ë°©ë²• 1: "LobbySpawn"ìœ¼ë¡œ ì‹œì‘í•˜ëŠ” ëª¨ë“  íŒŒíŠ¸ ì°¾ê¸°
	for _, obj in pairs(workspace:GetChildren()) do
		if obj:IsA("BasePart") and obj.Name:match("^LobbySpawn") then
			table.insert(lobbySpawns, obj)
		end
	end

	-- ë°©ë²• 2: GameObjects í´ë” ì•ˆì—ì„œ "LobbySpawn"ìœ¼ë¡œ ì‹œì‘í•˜ëŠ” íŒŒíŠ¸ë§Œ ì°¾ê¸°
	local lobbyObjectsFolder = workspace:FindFirstChild("LobbyObjects")
	local lobbySpawnsFolder = lobbyObjectsFolder:FindFirstChild("LobbySpawns")
	if lobbySpawnsFolder then
		for _, obj in pairs(lobbySpawnsFolder:GetChildren()) do
			if obj:IsA("BasePart") and obj.Name:match("^LobbySpawn") then
				table.insert(lobbySpawns, obj)
			end
		end
	end

	return lobbySpawns
end

-- ëœë¤ LobbySpawn ì„ íƒ í•¨ìˆ˜
local function getRandomLobbySpawn()
	local lobbySpawns = getLobbySpawns()

	if #lobbySpawns == 0 then
		warn("LobbySpawnì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê¸°ë³¸ LobbySpawnì„ ì‚¬ìš©í•©ë‹ˆë‹¤.")
		local defaultSpawn = workspace:FindFirstChild("LobbySpawn")
		if defaultSpawn and defaultSpawn:IsA("BasePart") then
			return defaultSpawn
		end
		return nil
	end

	-- ëœë¤í•˜ê²Œ í•˜ë‚˜ ì„ íƒ
	local randomIndex = math.random(1, #lobbySpawns)
	return lobbySpawns[randomIndex]
end

-- StartGameWall ì œê±° í•¨ìˆ˜
local function removeStartGameWall()
	local gameObjectsFolder = workspace:FindFirstChild("GameObjects")
	local startGameWall = gameObjectsFolder:WaitForChild("StartGameWall")
	if startGameWall then
		startGameWall:Destroy()
		print("StartGameWallì´ ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤.")
	else
		-- StartGameWall í´ë”ë‚˜ ëª¨ë¸ì¼ ìˆ˜ë„ ìˆìŒ
		local startGameWallFolder = workspace:FindFirstChild("StartGameWall")
		if startGameWallFolder then
			startGameWallFolder:Destroy()
			print("StartGameWall í´ë”/ëª¨ë¸ì´ ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤.")
		end
	end
end

-- í˜„ì¬ ìŒì•… ì •ì§€ í•¨ìˆ˜
local function stopCurrentMusic()
	-- 1. ê¸°ì¡´ì— ì—°ê²°ëœ "ë‹¤ìŒ ê³¡ ì¬ìƒ ì˜ˆì•½"ì´ ìˆë‹¤ë©´ í•´ì œ
	if musicConnection then
		musicConnection:Disconnect()
		musicConnection = nil
	end

	-- 2. í˜„ì¬ ìŒì•… ì •ì§€
	if currentMusic then
		currentMusic:Stop()
		currentMusic = nil
	end
end

-- ë¡œë¹„ ìŒì•… ì¬ìƒ í•¨ìˆ˜
local function playLobbyMusic()
	stopCurrentMusic()

	local lobbyMusicFolder = soundService:FindFirstChild("LobbyMusic")
	if not lobbyMusicFolder then
		warn("SoundServiceì—ì„œ LobbyMusic í´ë”ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
		return
	end

	local musicTracks = {}
	for _, sound in pairs(lobbyMusicFolder:GetChildren()) do
		if sound:IsA("Sound") then
			table.insert(musicTracks, sound)
		end
	end

	if #musicTracks == 0 then
		warn("LobbyMusic í´ë”ì— ìŒì•…ì´ ì—†ìŠµë‹ˆë‹¤.")
		return
	end

	-- ëœë¤ìœ¼ë¡œ í•˜ë‚˜ ì„ íƒí•˜ì—¬ ì¬ìƒ
	local randomIndex = math.random(1, #musicTracks)
	currentMusic = musicTracks[randomIndex]
	currentMusic:Play()

	-- ë…¸ë˜ê°€ ëë‚˜ë©´ ë‹¤ì‹œ ì´ í•¨ìˆ˜ë¥¼ ì‹¤í–‰í•´ì„œ ë¬´í•œ ë°˜ë³µ
	musicConnection = currentMusic.Ended:Connect(function()
		playLobbyMusic()
	end)
	print("ë¡œë¹„ ìŒì•… ì¬ìƒ: " .. currentMusic.Name)
end

-- ê²Œì„ ìŒì•… ì¬ìƒ í•¨ìˆ˜
local function playGameMusic()
	stopCurrentMusic()

	local gameMusicFolder = soundService:FindFirstChild("GameMusic")
	if not gameMusicFolder then
		warn("SoundServiceì—ì„œ GameMusic í´ë”ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
		return
	end

	local musicTracks = {}
	for _, sound in pairs(gameMusicFolder:GetChildren()) do
		if sound:IsA("Sound") then
			table.insert(musicTracks, sound)
		end
	end

	if #musicTracks == 0 then
		warn("GameMusic í´ë”ì— ìŒì•…ì´ ì—†ìŠµë‹ˆë‹¤.")
		return
	end

	-- ëœë¤ìœ¼ë¡œ í•˜ë‚˜ ì„ íƒí•˜ì—¬ ì¬ìƒ
	local randomIndex = math.random(1, #musicTracks)
	currentMusic = musicTracks[randomIndex]
	currentMusic:Play()

	-- ë…¸ë˜ê°€ ëë‚˜ë©´ ë‹¤ì‹œ ì´ í•¨ìˆ˜ë¥¼ ì‹¤í–‰í•´ì„œ ë¬´í•œ ë°˜ë³µ
	musicConnection = currentMusic.Ended:Connect(function()
		playGameMusic()
	end)
	print("ê²Œì„ ìŒì•… ì¬ìƒ: " .. currentMusic.Name)
end

-- í”Œë ˆì´ì–´ë¥¼ íˆ¬ëª…í•˜ê²Œ ë§Œë“œëŠ” í•¨ìˆ˜
local function makePlayerInvisible(character)
	for _, part in pairs(character:GetDescendants()) do
		if part:IsA("BasePart") then
			part.Transparency = 1
		else
			-- Decal, Texture ë“± ë‹¤ë¥¸ ê²ƒë“¤
			pcall(function()
				if part.Transparency then
					part.Transparency = 1
				end
			end)
		end
	end
	print(character.Name .. " íˆ¬ëª…í™” ì™„ë£Œ")
end

-- í”Œë ˆì´ì–´ë¥¼ ë³´ì´ê²Œ ë§Œë“œëŠ” í•¨ìˆ˜
local function makePlayerVisible(character)
	for _, part in pairs(character:GetDescendants()) do
		if part:IsA("BasePart") then
			if part.Name == "HumanoidRootPart" then
				part.Transparency = 1
			else
				part.Transparency = 0
			end
		else
			-- Decal, Texture ë“± ë‹¤ë¥¸ ê²ƒë“¤
			pcall(function()
				if part.Transparency then
					part.Transparency = 0
				end
			end)
		end
	end
	print(character.Name .. " ê°€ì‹œí™” ì™„ë£Œ")
end

-- ì‚´ì•„ìˆëŠ” Player íŒ€ì› ìˆ˜ í™•ì¸
local function getAlivePlayers()
	local playerTeam = Teams:FindFirstChild("Player")
	local alivePlayers = {}

	for _, player in pairs(Players:GetPlayers()) do
		if player.Team == playerTeam then
			local character = player.Character
			if character then
				local humanoid = character:FindFirstChild("Humanoid")
				if humanoid and humanoid.Health > 0 then
					table.insert(alivePlayers, player)
				end
			end
		end
	end

	return alivePlayers
end

-- íŒ€ ìŠ¹ë¦¬ ì²˜ë¦¬
local function handleVictory(winningTeam)
	gameEnded = true
	InRound.Value = false
	IsRestrictMovement.Value = false

	local teamName = winningTeam.Name

	-- ìŠ¹ë¦¬ ë©”ì‹œì§€ í‘œì‹œ
	if teamName == "Killer" then
		status.Value = "ğŸ”ª KILLER WINS! ğŸ”ª"

		-- Killer íŒ€ í”Œë ˆì´ì–´ë“¤ì˜ Killer Wins ì¦ê°€
		for _, player in pairs(Players:GetPlayers()) do
			if player.Team == winningTeam then
				local leaderstats = player:FindFirstChild("leaderstats")
				if leaderstats then
					local killerWins = leaderstats:FindFirstChild("Killer Wins")
					if killerWins then
						killerWins.Value = killerWins.Value + 1
					end
				end
			end
		end
	else -- Player íŒ€ ìŠ¹ë¦¬
		status.Value = "ğŸ‰ PLAYERS WIN! ğŸ‰"

		-- Player íŒ€ í”Œë ˆì´ì–´ë“¤ì˜ Player Wins ì¦ê°€
		for _, player in pairs(Players:GetPlayers()) do
			if player.Team == winningTeam then
				local leaderstats = player:FindFirstChild("leaderstats")
				if leaderstats then
					local playerWins = leaderstats:FindFirstChild("Player Wins")
					if playerWins then
						playerWins.Value = playerWins.Value + 1
					end
				end
			end
		end
	end

	print(teamName .. " íŒ€ ìŠ¹ë¦¬!")

	-- 5ì´ˆ ëŒ€ê¸°
	task.wait(5)

	-- ë¡œë¹„ë¡œ ì´ë™
	local lobbyTeam = Teams:FindFirstChild("Lobby")
	for _, plr in pairs(Players:GetPlayers()) do
		local randomLobbySpawn = getRandomLobbySpawn()
		local char = plr.Character
		if char then
			local humanRoot = char:FindFirstChild("HumanoidRootPart")
			if humanRoot then
				humanRoot.CFrame = randomLobbySpawn.CFrame
				humanRoot.Anchored = false
			end

			-- ë‹¤ì‹œ ë³´ì´ê²Œ ë§Œë“¤ê¸°
			makePlayerVisible(char)
		end

		-- Lobby íŒ€ìœ¼ë¡œ ë³€ê²½
		if lobbyTeam then
			plr.Team = lobbyTeam
			plr.TeamColor = lobbyTeam.TeamColor
		end
	end

	-- ë¡œë¹„ ìŒì•… ì¬ìƒ
	playLobbyMusic()
end

InRound.Changed:Connect(function()
	-- ê²Œì„ì´ ì¢…ë£Œë˜ë©´ ê³µê³¼ ë²½ëŒ ì‚­ì œ
	if InRound.Value == false then
		if _G.cleanupGame then
			_G.cleanupGame()
		end
	end
	if InRound.Value == false and not gameEnded then
		-- íŒ€ë“¤
		local Teams = game:GetService("Teams")
		local lobbyTeam = Teams:FindFirstChild("Lobby")

		-- ì´ë™ ì œí•œ í•´ì œ
		IsRestrictMovement.Value = false

		-- ë¼ìš´ë“œê°€ ëë‚˜ë©´ ë¡œë¹„ë¡œ í…”ë ˆí¬íŠ¸ + Lobby íŒ€ìœ¼ë¡œ ë³€ê²½
		for i, plr in pairs(game.Players:GetChildren()) do
			local randomLobbySpawn = getRandomLobbySpawn()
			local char = plr.Character
			if char then
				local humanRoot = char:WaitForChild("HumanoidRootPart")
				humanRoot.CFrame = randomLobbySpawn.CFrame

				-- Anchored í•´ì œ
				humanRoot.Anchored = false

				-- ë‹¤ì‹œ ë³´ì´ê²Œ ë§Œë“¤ê¸°
				makePlayerVisible(char)
			end

			-- Lobby íŒ€ìœ¼ë¡œ ë¦¬ì…‹
			if lobbyTeam then
				plr.Team = lobbyTeam
				plr.TeamColor = lobbyTeam.TeamColor
			end
		end

		-- ë¡œë¹„ ìŒì•… ì¬ìƒ
		playLobbyMusic()
	end
end)

-- í”Œë ˆì´ì–´ë¥¼ ê° íŒ€ì— ë§ê²Œ í…”ë ˆí¬íŠ¸í•˜ëŠ” í•¨ìˆ˜
local function teleportPlayersByTeam()
	local Teams = game:GetService("Teams")
	local killerTeam = Teams:FindFirstChild("Killer")
	local playerTeam = Teams:FindFirstChild("Player")

	if not cameraPart then
		warn("CameraPartë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!")
	end

	-- ëœë¤ MapSpawn ì„ íƒ
	local randomMapSpawn = getRandomMapSpawn()

	for _, plr in pairs(game.Players:GetPlayers()) do
		local char = plr.Character
		if char then
			local humanRoot = char:FindFirstChild("HumanoidRootPart")
			if humanRoot then
				if plr.Team == killerTeam and cameraPart then
					-- KillerëŠ” CameraPart ìœ„ì¹˜ë¡œ
					humanRoot.CFrame = cameraPart.CFrame

					-- ì¦‰ì‹œ ê³ ì •
					humanRoot.Anchored = true

					-- íˆ¬ëª…í•˜ê²Œ ë§Œë“¤ê¸°
					makePlayerInvisible(char)

					print(plr.Name .. " (Killer) - CameraPartë¡œ í…”ë ˆí¬íŠ¸, ê³ ì • ë° íˆ¬ëª…í™”")
				elseif plr.Team == playerTeam and randomMapSpawn then
					-- PlayerëŠ” MapSpawn ìœ„ì¹˜ë¡œ
					humanRoot.CFrame = randomMapSpawn.CFrame

					-- PlayerëŠ” ê³ ì •í•˜ì§€ ì•ŠìŒ
					humanRoot.Anchored = false

					-- PlayerëŠ” ë³´ì´ê²Œ (í˜¹ì‹œ ëª°ë¼ì„œ)
					makePlayerVisible(char)

					print(plr.Name .. " (Player) - MapSpawnìœ¼ë¡œ í…”ë ˆí¬íŠ¸")
				end
			end
		end
	end
end

local function round()
	while true do
		InRound.Value = false
		IsRestrictMovement.Value = false -- ì¶”ê°€
		gameEnded = false

		repeat
			for i = intermission, 0, -1 do
				local playerCount = #Players:GetPlayers()
				status.Value = "Game will start in "
					.. i
					.. " seconds\nMinimum 2 players to start!\nPlayers: "
					.. playerCount
					.. "/15: "
				task.wait(1)
			end

			-- í”Œë ˆì´ì–´ ìˆ˜ í™•ì¸
			local playerCount = #Players:GetPlayers()
			if playerCount < 2 then
				status.Value = "Not enough players! Waiting...\nPlayers: " .. playerCount .. "/15"
				task.wait(2)
			end
		until #Players:GetPlayers() >= 2

		-- intermissionì´ ëë‚˜ë©´ íŒ€ ë°°ì •
		status.Value = "Selecting Killer..."
		local selectedPlayer, plrIcon
		if _G.pickRandomPlayer then
			selectedPlayer, plrIcon = _G.pickRandomPlayer() -- ë°˜í™˜ê°’ ë°›ê¸°
		end

		if selectedPlayer then
			status.Value = "Killer is: " .. selectedPlayer.Name .. "!"
		else
			status.Value = "Killer selected!"
		end
		task.wait(2)

		-- ê·¸ ë‹¤ìŒ MapSpawnìœ¼ë¡œ í…”ë ˆí¬íŠ¸
		status.Value = "Teleporting to map..."
		teleportPlayersByTeam()

		-- í…”ë ˆí¬íŠ¸ ì§í›„ ì´ë™ ì œí•œ ì‹œì‘! (ì¤‘ìš”)
		IsRestrictMovement.Value = true

		-- í…”ë ˆí¬íŠ¸ ì§í›„ ê²Œì„ ìŒì•… ì¬ìƒ
		playGameMusic()

		-- í…”ë ˆí¬íŠ¸ í›„ ë¸”ëŸ­ ìƒì„±
		if _G.createBricks then
			_G.createBricks()
		end

		-- StartGameWall ìƒì„±
		createStartGameWall()

		-- 5ì´ˆ ëŒ€ê¸°
		for i = 5, 0, -1 do
			status.Value = "Game starting in " .. i .. " seconds"
			task.wait(1)
		end

		-- StartGameWall ì œê±°
		removeStartGameWall()

		-- ê·¸ ë‹¤ìŒ InRoundë¥¼ trueë¡œ ì„¤ì •
		InRound.Value = true

		-- InRoundê°€ trueê°€ ë˜ë©´ ê³µ ìƒì„±
		if _G.createBall then
			_G.createBall()
		end

		-- ê²Œì„ ì§„í–‰ (ìŠ¹íŒ¨ ì¡°ê±´ ì²´í¬)
		local killerTeam = Teams:FindFirstChild("Killer")
		local playerTeam = Teams:FindFirstChild("Player")

		for i = roundLength, 0, -1 do
			if gameEnded then
				break
			end

			-- ìƒì¡´ì ì²´í¬
			local alivePlayers = getAlivePlayers()

			if #alivePlayers == 0 then
				-- ëª¨ë“  Playerê°€ ì£½ìŒ â†’ Killer ìŠ¹ë¦¬
				status.Value = "All players eliminated!"
				task.wait(2)
				handleVictory(killerTeam)
				break
			end

			status.Value = "Time remaining: " .. i .. "s | Survivors: " .. #alivePlayers
			task.wait(1)
		end

		-- ì‹œê°„ ì´ˆê³¼ â†’ Player ìŠ¹ë¦¬
		if not gameEnded then
			local alivePlayers = getAlivePlayers()
			if #alivePlayers > 0 then
				status.Value = "Time's up! Players survived!"
				task.wait(2)
				handleVictory(playerTeam)
			end
		end

		task.wait(3) -- ë‹¤ìŒ ë¼ìš´ë“œ ì „ ëŒ€ê¸°
	end
end

-- ê²Œì„ ì‹œì‘ ì‹œ ë¡œë¹„ ìŒì•… ì¬ìƒ
playLobbyMusic()

task.spawn(round)
