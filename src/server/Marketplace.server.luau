-- Marketplace.lua (ServerScriptService)
-- ëª¨ë“  ê°œë°œì ìƒí’ˆ ê²°ì œë¥¼ ì¤‘ì•™ì—ì„œ ì²˜ë¦¬í•˜ëŠ” ìŠ¤í¬ë¦½íŠ¸

local MarketplaceService = game:GetService("MarketplaceService")
local Players = game:GetService("Players")
local Teams = game:GetService("Teams")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local soundService = game:GetService("SoundService")
local BGMFolder = soundService:WaitForChild("BGM")
local purchaseSound = BGMFolder:WaitForChild("Purchase")
local donateSound = BGMFolder:WaitForChild("Donate")
local reviveSound = BGMFolder:WaitForChild("Revive")

local Mode = ReplicatedStorage:WaitForChild("Mode")

-- ìƒí’ˆ ID ì •ì˜
local REVIVE_PRODUCT_ID = 3516958082
local FORCE_KILLER_PRODUCT_ID = 3511107004

-- Donation ìƒí’ˆ IDì™€ ê¸ˆì•¡ ë§¤í•‘
local DONATION_PRODUCTS = {
	[3498063120] = 10, -- ì˜ˆì‹œ: 10 Robux í›„ì›
	[3498065337] = 20,
	[3498065336] = 50,
	[3498065350] = 100,
	[3498065348] = 200,
	[3498065328] = 500,
	[3498065360] = 1000,
	[3498065327] = 2000,
	[3498065359] = 5000,
	[3498065325] = 10000,
	-- [ìƒí’ˆID] = í›„ì›ê¸ˆì•¡,
}

-- RemoteEvents ìƒì„±/ê°€ì ¸ì˜¤ê¸°
local function getOrCreateEvent(name)
	local ev = ReplicatedStorage:FindFirstChild(name)
	if not ev then
		ev = Instance.new("RemoteEvent")
		ev.Name = name
		ev.Parent = ReplicatedStorage
	end
	return ev
end

local hideGuiEvent = getOrCreateEvent("HideKillerGui")

-- [Studio í…ŒìŠ¤íŠ¸ìš©] ë¶€í™œ ì‹œë®¬ë ˆì´ì…˜ ì´ë²¤íŠ¸
local simulateReviveEvent = ReplicatedStorage:WaitForChild("SimulateRevive")
local simulateKillerEvent = ReplicatedStorage:WaitForChild("SimulateKiller")

-- ë¶€í™œ ì²˜ë¦¬ë¥¼ ìœ„í•œ í•¨ìˆ˜ë“¤ (RoundManagerì—ì„œ ê°€ì ¸ì˜´)
local function getRandomMapSpawn()
	local mapSpawns = {}

	for _, obj in pairs(workspace:GetChildren()) do
		if obj:IsA("BasePart") and obj.Name:match("^MapSpawn") then
			table.insert(mapSpawns, obj)
		end
	end

	local gameObjectsFolder = workspace:FindFirstChild("GameObjects")
	local mapSpawnsFolder = gameObjectsFolder and gameObjectsFolder:FindFirstChild("MapSpawns")
	if mapSpawnsFolder then
		for _, obj in pairs(mapSpawnsFolder:GetChildren()) do
			if obj:IsA("BasePart") and obj.Name:match("^MapSpawn") then
				table.insert(mapSpawns, obj)
			end
		end
	end

	if #mapSpawns == 0 then
		warn("MapSpawnì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
		return workspace:FindFirstChild("MapSpawn")
	end

	return mapSpawns[math.random(1, #mapSpawns)]
end

local function makePlayerVisible(character)
	for _, part in pairs(character:GetDescendants()) do
		if part:IsA("BasePart") then
			if part.Name == "HumanoidRootPart" then
				part.Transparency = 1
			else
				part.Transparency = 0
			end
		else
			pcall(function()
				if part.Transparency then
					part.Transparency = 0
				end
			end)
		end
	end
	print(character.Name .. " ê°€ì‹œí™” ì™„ë£Œ")
end

local function processRevivePurchase(player)
	local InRound = ReplicatedStorage:FindFirstChild("InRound")
	local Status = ReplicatedStorage:FindFirstChild("Status")

	-- ê²Œì„ ì¢…ë£Œ ì²´í¬ (WINS ë¬¸ìì—´ í¬í•¨ ì—¬ë¶€)
	local isGameOver = Status and string.find(string.upper(Status.Value), "WINS")
	if InRound and InRound.Value == true and player.Team.Name == "Lobby" and not isGameOver then
		player.Team = Teams:FindFirstChild("Player")
		--player:LoadCharacter()

		local char = player.Character or player.CharacterAdded:Wait()
		local humanoid = char:FindFirstChild("Humanoid")
		-- ìŠ¤í”¼ë“œ ëª¨ë“œì¼ë•Œ ì†ë„ì²˜ë¦¬
		if humanoid and Mode.Value == "Speed" then
			humanoid.WalkSpeed = 45
		end
		local humanRoot = char:WaitForChild("HumanoidRootPart")

		local randomSpawn = getRandomMapSpawn()
		if randomSpawn then
			humanRoot.CFrame = randomSpawn.CFrame + Vector3.new(0, 3, 0)
		end

		makePlayerVisible(char)
		humanRoot.Anchored = false

		return true
	end
	return false
end
-- ë¶€í™œ ì²˜ë¦¬ í•¨ìˆ˜
local function processRevive(player)
	local success = processRevivePurchase(player)
	local Inform = ReplicatedStorage:FindFirstChild("Inform")
	if success then
		if reviveSound then
			reviveSound:Play()
		end

		-- ë¶€í™œ ì•Œë¦¼ ë©”ì‹œì§€ í‘œì‹œ
		if Inform then
			Inform.Value = player.Name .. " has revived!"
		end
		print("=== ë¶€í™œ êµ¬ë§¤ ì²˜ë¦¬ ì™„ë£Œ: " .. player.Name .. " ===")

		return Enum.ProductPurchaseDecision.PurchaseGranted
	else
		-- ëŠ¦ì€ êµ¬ë§¤ (ì˜ˆì•½ ì²˜ë¦¬ë¨)
		print("ëŠ¦ì€ êµ¬ë§¤ - ì˜ˆì•½ ì²˜ë¦¬ë¨: " .. player.Name)
		return Enum.ProductPurchaseDecision.PurchaseGranted
	end
end

-- [Studio í…ŒìŠ¤íŠ¸ìš©] ë¶€í™œ ì‹œë®¬ë ˆì´ì…˜ ì²˜ë¦¬
simulateReviveEvent.OnServerEvent:Connect(function(player)
	print("=== [í…ŒìŠ¤íŠ¸] ë¶€í™œ ì‹œë®¬ë ˆì´ì…˜:", player.Name, "===")

	local success = processRevive(player)
	if success then
		print("=== [í…ŒìŠ¤íŠ¸] ë¶€í™œ ì„±ê³µ! ===")
	else
		print("=== [í…ŒìŠ¤íŠ¸] ë¶€í™œ ì‹¤íŒ¨ (ì¡°ê±´ ë¯¸ë‹¬) ===")
	end
end)

-- í‚¬ëŸ¬ ê°•ì œ êµ¬ë§¤ ì²˜ë¦¬ í•¨ìˆ˜
local function processKiller(player)
	local Inform = ReplicatedStorage:FindFirstChild("Inform")

	-- _Gì—ì„œ í‚¬ëŸ¬ ì„ íƒ ê´€ë ¨ í•¨ìˆ˜ë“¤ ê°€ì ¸ì˜¤ê¸°
	if not _G.processKillerPurchase then
		warn("í‚¬ëŸ¬ êµ¬ë§¤ ì²˜ë¦¬ í•¨ìˆ˜ê°€ ì•„ì§ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤!")
		return Enum.ProductPurchaseDecision.NotProcessedYet
	end

	local success = _G.processKillerPurchase(player)

	if success then
		print("=== í‚¬ëŸ¬ êµ¬ë§¤ ì²˜ë¦¬ ì™„ë£Œ: " .. player.Name .. " ===")
		hideGuiEvent:FireAllClients()

		if purchaseSound then
			purchaseSound:Play()
		end

		-- í‚¬ëŸ¬ êµ¬ë§¤ ì•Œë¦¼ ë©”ì‹œì§€ í‘œì‹œ
		if Inform then
			Inform.Value = player.Name .. " purchased killer item!"
		end

		return Enum.ProductPurchaseDecision.PurchaseGranted
	else
		-- ëŠ¦ì€ êµ¬ë§¤ (ì˜ˆì•½ ì²˜ë¦¬ë¨)
		print("ëŠ¦ì€ êµ¬ë§¤ - ì˜ˆì•½ ì²˜ë¦¬ë¨: " .. player.Name)
		return Enum.ProductPurchaseDecision.PurchaseGranted
	end
end

-------------------------------------------------
-- [Studio í…ŒìŠ¤íŠ¸ìš©] í‚¬ëŸ¬ êµ¬ë§¤ ì‹œë®¬ë ˆì´ì…˜
-------------------------------------------------

simulateKillerEvent.OnServerEvent:Connect(function(player)
	local success = processKiller(player)
	if success then
		print("[í…ŒìŠ¤íŠ¸] í‚¬ëŸ¬ ì•„ì´í…œ êµ¬ë§¤ ì„±ê³µ")
	else
		print("=== [í…ŒìŠ¤íŠ¸] í‚¬ëŸ¬ ì•„ì´í…œ êµ¬ë§¤ ì‹¤íŒ¨ (ì¡°ê±´ ë¯¸ë‹¬) ===")
	end
end)

-- Donation ì²˜ë¦¬ í•¨ìˆ˜
local function processDonation(player, receiptInfo)
	local donationAmount = DONATION_PRODUCTS[receiptInfo.ProductId]

	if not donationAmount then
		warn("ì•Œ ìˆ˜ ì—†ëŠ” í›„ì› ìƒí’ˆ:", receiptInfo.ProductId)
		return Enum.ProductPurchaseDecision.PurchaseGranted
	end

	print("=== í›„ì› ì²˜ë¦¬: " .. player.Name .. " - " .. donationAmount .. " Robux ===")

	-- â­ ë¦¬ë”ë³´ë“œì˜ DataStoreNameê³¼ ë™ì¼í•˜ê²Œ ì‚¬ìš©
	local DONATION_DATASTORE_NAME = "DonateBoardDataStore_V1"

	local DataStoreService = game:GetService("DataStoreService")
	local DonationDataStore = DataStoreService:GetOrderedDataStore(DONATION_DATASTORE_NAME)

	pcall(function()
		local currentDonation = DonationDataStore:GetAsync(player.UserId) or 0
		local newTotal = currentDonation + donationAmount
		DonationDataStore:SetAsync(player.UserId, newTotal)

		print("í›„ì› ì €ì¥ ì™„ë£Œ:", player.Name, "ì´ì•¡:", newTotal)
	end)

	-- ì•Œë¦¼ ë©”ì‹œì§€
	local Inform = ReplicatedStorage:FindFirstChild("Inform")
	if Inform then
		Inform.Value = "ğŸ’ " .. player.Name .. " donated " .. donationAmount .. " Robux!"
	end
	if donateSound then
		donateSound:Play()
	end

	return Enum.ProductPurchaseDecision.PurchaseGranted
end

-- ì¤‘ì•™ ê²°ì œ ì²˜ë¦¬ í•¨ìˆ˜
MarketplaceService.ProcessReceipt = function(receiptInfo)
	local player = Players:GetPlayerByUserId(receiptInfo.PlayerId)

	-- í”Œë ˆì´ì–´ê°€ ì—†ìœ¼ë©´ ì²˜ë¦¬ ë³´ë¥˜
	if not player then
		return Enum.ProductPurchaseDecision.NotProcessedYet
	end

	print("=== ê²°ì œ ì²˜ë¦¬ ì‹œì‘ ===")
	print("í”Œë ˆì´ì–´:", player.Name)
	print("ìƒí’ˆ ID:", receiptInfo.ProductId)

	-- ë¶€í™œ ì•„ì´í…œ ì²˜ë¦¬
	if receiptInfo.ProductId == REVIVE_PRODUCT_ID then
		return processRevive(player)
	end

	-- í‚¬ëŸ¬ ê°•ì œ êµ¬ë§¤ ì²˜ë¦¬
	if receiptInfo.ProductId == FORCE_KILLER_PRODUCT_ID then
		return processKiller(player)
	end

	-- â­ ì´ ë¶€ë¶„ì´ ì¶”ê°€ë¨!
	-- Donation ìƒí’ˆ ì²˜ë¦¬
	if DONATION_PRODUCTS[receiptInfo.ProductId] then
		return processDonation(player, receiptInfo)
	end

	-- ì•Œ ìˆ˜ ì—†ëŠ” ìƒí’ˆ (ë¯¸ë˜ í™•ì¥ìš©)
	warn("ì•Œ ìˆ˜ ì—†ëŠ” ìƒí’ˆ ID:", receiptInfo.ProductId)
	return Enum.ProductPurchaseDecision.PurchaseGranted
end

print("==============================================")
print("ì¤‘ì•™ ê²°ì œ ì²˜ë¦¬ ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì™„ë£Œ")
print("ë¶€í™œ ìƒí’ˆ ID:", REVIVE_PRODUCT_ID)
print("í‚¬ëŸ¬ ê°•ì œ ìƒí’ˆ ID:", FORCE_KILLER_PRODUCT_ID)
print("==============================================")
