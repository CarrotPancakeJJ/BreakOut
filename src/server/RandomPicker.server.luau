local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Teams = game:GetService("Teams")

local killerTeam = Teams:WaitForChild("Killer")
local playerTeam = Teams:WaitForChild("Player")

-------------------------------------------------
-- RemoteEvents
-------------------------------------------------

-- ë£°ë › ì‹œì‘ (ê¸°ì¡´)
local showKillerEvent = ReplicatedStorage:FindFirstChild("ShowKiller")
if not showKillerEvent then
	showKillerEvent = Instance.new("RemoteEvent")
	showKillerEvent.Name = "ShowKiller"
	showKillerEvent.Parent = ReplicatedStorage
end

-- ë£°ë › ì¢…ë£Œ (ì‹ ê·œ)
local rouletteFinishedEvent = ReplicatedStorage:FindFirstChild("RouletteFinished")
if not rouletteFinishedEvent then
	rouletteFinishedEvent = Instance.new("RemoteEvent")
	rouletteFinishedEvent.Name = "RouletteFinished"
	rouletteFinishedEvent.Parent = ReplicatedStorage
end

-------------------------------------------------
-- ì•„ì´ì½˜ ê°€ì ¸ì˜¤ê¸° (ê¸°ì¡´ ìœ ì§€)
-------------------------------------------------

local noIconFound = ""

local function GetPlayerIcon(player)
	if not player or not player.UserId then
		return noIconFound
	end

	local content, isReady
	local ok, err = pcall(function()
		content, isReady =
			Players:GetUserThumbnailAsync(player.UserId, Enum.ThumbnailType.HeadShot, Enum.ThumbnailSize.Size420x420)
	end)

	if ok and isReady and type(content) == "string" then
		return content
	end

	return noIconFound
end

-------------------------------------------------
-- Killer ì„ íƒ (íŒ€ ë°°ì • X)
-------------------------------------------------

local currentKiller = nil
local teamAssigned = false

local function pickRandomPlayer()
	local playerList = Players:GetPlayers()
	if #playerList == 0 then
		warn("[ì„œë²„] í”Œë ˆì´ì–´ê°€ ì—†ìŠµë‹ˆë‹¤.")
		return
	end

	currentKiller = playerList[math.random(1, #playerList)]
	teamAssigned = false

	print(string.format("[ì„œë²„] Killer í›„ë³´ ì„ íƒ: %s (UserId=%d)", currentKiller.Name, currentKiller.UserId))

	local plrIcon = GetPlayerIcon(currentKiller)

	-- ğŸ”¥ ì—¬ê¸°ì„œëŠ” íŒ€ ë°°ì • ì•ˆ í•¨
	showKillerEvent:FireAllClients(currentKiller.Name, plrIcon)
	print("[ì„œë²„] ë£°ë › ì‹œì‘ ì•Œë¦¼ ì „ì†¡")

	return currentKiller, plrIcon
end

-------------------------------------------------
-- ë£°ë › ì¢…ë£Œ â†’ íŒ€ ë°°ì •
-------------------------------------------------

rouletteFinishedEvent.OnServerEvent:Connect(function(playerWhoFired)
	if teamAssigned then
		return
	end
	if not currentKiller then
		return
	end

	teamAssigned = true

	for _, plr in ipairs(Players:GetPlayers()) do
		if plr == currentKiller then
			plr.Team = killerTeam
			plr.TeamColor = killerTeam.TeamColor
			print(plr.Name .. " â†’ Killer íŒ€")
		else
			plr.Team = playerTeam
			plr.TeamColor = playerTeam.TeamColor
			print(plr.Name .. " â†’ Player íŒ€")
		end
	end

	print("[ì„œë²„] íŒ€ ë°°ì • ì™„ë£Œ (íŠ¸ë¦¬ê±°:", playerWhoFired.Name, ")")
end)

-------------------------------------------------
-- ì „ì—­ í•¨ìˆ˜ export (ê¸°ì¡´ ìœ ì§€)
-------------------------------------------------

_G.pickRandomPlayer = pickRandomPlayer
